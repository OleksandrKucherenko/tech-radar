# Automated release workflow triggered by version tags
# Creates minified radar.js releases and publishes to GitHub Releases
name: Create Release

on:
  push:
    tags:
      - 'v*' # Trigger on any tag starting with 'v' (e.g., v0.14.1, v1.0.0-alpha.2+meta.1)

  # Allows manual workflow dispatch for testing
  workflow_dispatch:
    inputs:
      tag:
        description: 'Version tag (e.g., v0.14.1)'
        required: true
        type: string

# Permissions needed for creating releases
permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          else
            TAG_NAME="${GITHUB_REF#refs/tags/}"
          fi

          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT

          # Remove 'v' prefix for version number
          VERSION="${TAG_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "üì¶ Tag: $TAG_NAME"
          echo "üî¢ Version: $VERSION"

      - name: Validate semver format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Validate semver format (basic check for X.Y.Z with optional prerelease and metadata)
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.]+)?(\+[a-zA-Z0-9\.]+)?$'; then
            echo "‚ùå Error: Version '$VERSION' does not match semver format"
            echo "Expected format: X.Y.Z[-prerelease][+metadata]"
            echo "Examples: 0.14.1, 1.0.0-alpha.2, 0.20.0-beta+meta.1"
            exit 1
          fi
          echo "‚úÖ Version format is valid"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build minified release
        env:
          RELEASE_VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "üî® Building radar.js version $RELEASE_VERSION..."
          bun run build

          # Verify output file exists
          RELEASE_FILE="docs/release/radar-$RELEASE_VERSION.js"
          if [ ! -f "$RELEASE_FILE" ]; then
            echo "‚ùå Error: Release file not found at $RELEASE_FILE"
            exit 1
          fi

          FILE_SIZE=$(stat -f%z "$RELEASE_FILE" 2>/dev/null || stat -c%s "$RELEASE_FILE")
          echo "‚úÖ Built $RELEASE_FILE (${FILE_SIZE} bytes)"
          echo "release_file=$RELEASE_FILE" >> $GITHUB_ENV

      - name: Delete existing release if tag was reassigned
        run: |
          TAG_NAME="${{ steps.version.outputs.tag }}"

          # Check if release exists
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Release $TAG_NAME already exists, deleting it..."
            gh release delete "$TAG_NAME" --yes --cleanup-tag 2>/dev/null || true
            echo "‚úÖ Existing release deleted"
          else
            echo "‚ÑπÔ∏è  No existing release found for $TAG_NAME"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create GitHub Release
        id: create_release
        run: |
          TAG_NAME="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_FILE="docs/release/radar-$VERSION.js"

          # Generate release notes
          RELEASE_NOTES="## Tech Radar Release $TAG_NAME

### üì¶ Release Artifact

- **Minified version:** \`radar-$VERSION.js\`
- **Built from:** \`docs/radar.js\`
- **D3.js version:** v7
- **Supports:** 2-8 quadrants, 4-8 rings

### üöÄ Usage

\`\`\`html
<script src=\"https://d3js.org/d3.v7.min.js\"></script>
<script src=\"https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/radar-$VERSION.js\"></script>
<script>
  radar_visualization({
    svg_id: \"radar\",
    width: 1450,
    height: 1000,
    colors: {
      background: \"#fff\",
      grid: \"#dddde0\",
      inactive: \"#ddd\"
    },
    quadrants: [
      { name: \"Languages\" },
      { name: \"Infrastructure\" },
      { name: \"Datastores\" },
      { name: \"Data Management\" }
    ],
    rings: [
      { name: \"ADOPT\", color: \"#5ba300\" },
      { name: \"TRIAL\", color: \"#009eb0\" },
      { name: \"ASSESS\", color: \"#c7ba00\" },
      { name: \"HOLD\", color: \"#e09b96\" }
    ],
    entries: [
      // Your technology entries here
    ]
  });
</script>
\`\`\`

### üìù Commit

**SHA:** \`${GITHUB_SHA:0:7}\`
"

          # Create release
          gh release create "$TAG_NAME" \
            "$RELEASE_FILE" \
            --title "Release $TAG_NAME" \
            --notes "$RELEASE_NOTES" \
            --target "${GITHUB_SHA}"

          echo "‚úÖ Release $TAG_NAME created successfully"
          echo "release_url=$(gh release view $TAG_NAME --json url -q .url)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Add release summary
        run: |
          TAG_NAME="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_URL="${{ steps.create_release.outputs.release_url }}"

          echo "## üéâ Release $TAG_NAME Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** [$TAG_NAME]($RELEASE_URL)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`radar-$VERSION.js\` - Minified release version" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì• Download" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Direct download" >> $GITHUB_STEP_SUMMARY
          echo "wget https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/radar-$VERSION.js" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ The release has been published to GitHub Releases." >> $GITHUB_STEP_SUMMARY
